#!/usr/bin/env python3
"""
ÏÑ∏Ìè¨ÌÉÄÏûÖÎ≥Ñ enhancer intersect SNPÎì§Ïùò Îß®ÌïòÌÉÑ ÌîåÎ°Ø
"""
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import norm
import gzip

def load_celltype_annotations():
    """ÏÑ∏Ìè¨ÌÉÄÏûÖÎ≥Ñ annotation Îç∞Ïù¥ÌÑ∞ Î°úÎìú"""
    
    print("üß¨ ÏÑ∏Ìè¨ÌÉÄÏûÖÎ≥Ñ annotation Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...")
    
    celltypes = {
        'Microglia': 'Neg_cleaned',
        'Neuron': 'NeuN_cleaned', 
        'Oligodendrocyte': 'Olig_cleaned',
        'Dopaminergic': 'Nurr_cleaned'
    }
    
    all_annotations = {}
    
    for celltype, file_prefix in celltypes.items():
        print(f"  {celltype} Î°úÎî© Ï§ë...")
        
        # ÏóºÏÉâÏ≤¥ 1Î≤àÎßå Î®ºÏ†Ä ÌÖåÏä§Ìä∏
        annot_file = f"/cephfs/volumes/hpc_data_prj/eng_waste_to_protein/ae035a41-20d2-44f3-aa46-14424ab0f6bf/repositories/bomin/ldsc_results/annotations/{file_prefix}.1.annot.gz"
        
        try:
            df = pd.read_csv(annot_file, sep='\t', compression='gzip')
            
            # ÎßàÏßÄÎßâ Ïó¥Ïù¥ enhancer annotation
            enhancer_col = df.columns[-1]  # ÎßàÏßÄÎßâ Ïó¥
            
            # IntersectÎêú SNPÎì§Îßå ÏÑ†ÌÉù
            intersect_snps = df[df[enhancer_col] == 1]['SNP'].tolist()
            
            print(f"    ÏóºÏÉâÏ≤¥ 1: {len(intersect_snps)}Í∞ú SNPÍ∞Ä {celltype} enhancerÏôÄ intersect")
            
            all_annotations[celltype] = {
                'intersect_snps': set(intersect_snps),
                'total_snps': len(df),
                'intersect_count': len(intersect_snps)
            }
            
        except Exception as e:
            print(f"    Ïò§Î•ò: {e}")
            all_annotations[celltype] = {
                'intersect_snps': set(),
                'total_snps': 0,
                'intersect_count': 0
            }
    
    return all_annotations

def load_gwas_with_positions():
    """GWAS Îç∞Ïù¥ÌÑ∞ÏôÄ ÏúÑÏπò Ï†ïÎ≥¥ Ìï®Íªò Î°úÎìú"""
    
    print("üìä GWAS Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...")
    
    # GWAS Îç∞Ïù¥ÌÑ∞
    gwas_file = "/cephfs/volumes/hpc_data_prj/eng_waste_to_protein/ae035a41-20d2-44f3-aa46-14424ab0f6bf/repositories/bomin/ldsc_results/sumstats/parkinson_gwas.sumstats.gz"
    
    # ÏÉòÌîåÎßÅÌï¥ÏÑú Î°úÎìú (Î©îÎ™®Î¶¨ Ï†àÏïΩ)
    sample_size = 500000
    
    print(f"  GWAS Îç∞Ïù¥ÌÑ∞ ÏÉòÌîåÎßÅ Î°úÎî© Ï§ë (n={sample_size:,})...")
    
    df = pd.read_csv(gwas_file, sep='\t', compression='gzip', nrows=sample_size)
    
    # P-value Í≥ÑÏÇ∞
    df['P'] = 2 * (1 - norm.cdf(np.abs(df['Z'])))
    df['-log10P'] = -np.log10(np.maximum(df['P'], 1e-50))
    
    # ÏúÑÏπò Ï†ïÎ≥¥ Ï∂îÍ∞Ä (Í∞ÑÎã®Ìïú Î∞©Î≤ï: SNP ID Í∏∞Î∞ò Í∞ÄÏÉÅ ÏúÑÏπò)
    # Ïã§Ï†úÎ°úÎäî .bim ÌååÏùºÏóêÏÑú Í∞ÄÏ†∏ÏôÄÏïº ÌïòÏßÄÎßå, Îç∞Ïù¥ÌÑ∞Í∞Ä ÌÅ¨ÎØÄÎ°ú Í∞ÑÎã®Ìûà Ï≤òÎ¶¨
    df['CHR'] = 1  # ÏóºÏÉâÏ≤¥ 1Î≤àÎßå Ï≤òÎ¶¨
    df['BP'] = range(len(df))  # ÏàúÏÑúÎåÄÎ°ú ÏúÑÏπò Ìï†Îãπ
    
    print(f"  Î°úÎî© ÏôÑÎ£å: {len(df):,} SNPs")
    print(f"  P-value Î≤îÏúÑ: {df['P'].min():.2e} - {df['P'].max():.2e}")
    
    return df

def create_celltype_manhattan_plots(gwas_df, annotations):
    """ÏÑ∏Ìè¨ÌÉÄÏûÖÎ≥Ñ Îß®ÌïòÌÉÑ ÌîåÎ°Ø ÏÉùÏÑ±"""
    
    print("üóΩ ÏÑ∏Ìè¨ÌÉÄÏûÖÎ≥Ñ Îß®ÌïòÌÉÑ ÌîåÎ°Ø ÏÉùÏÑ± Ï§ë...")
    
    # 4Í∞ú ÏÑ∏Ìè¨ÌÉÄÏûÖ ÏÑúÎ∏åÌîåÎ°Ø
    fig, axes = plt.subplots(2, 2, figsize=(20, 16))
    axes = axes.flatten()
    
    celltypes = ['Microglia', 'Neuron', 'Oligodendrocyte', 'Dopaminergic']
    colors_intersect = ['red', 'darkgreen', 'purple', 'orange']
    colors_background = ['lightcoral', 'lightgreen', 'plum', 'moccasin']
    
    # Ïú†ÏùòÏÑ± Í∏∞Ï§ÄÏÑ†
    genome_wide = -np.log10(5e-8)
    suggestive = -np.log10(1e-5)
    
    for i, celltype in enumerate(celltypes):
        ax = axes[i]
        
        print(f"  {celltype} ÌîåÎ°Ø ÏÉùÏÑ± Ï§ë...")
        
        # Ìï¥Îãπ ÏÑ∏Ìè¨ÌÉÄÏûÖÏùò intersect SNPÎì§
        intersect_snps = annotations[celltype]['intersect_snps']
        intersect_count = len(intersect_snps)
        
        # GWAS Îç∞Ïù¥ÌÑ∞ÏóêÏÑú intersect Ïó¨Î∂Ä ÌëúÏãú
        gwas_df['is_intersect'] = gwas_df['SNP'].isin(intersect_snps)
        
        # Non-intersect SNPÎì§ (Î∞∞Í≤Ω)
        non_intersect = gwas_df[~gwas_df['is_intersect']]
        intersect_data = gwas_df[gwas_df['is_intersect']]
        
        print(f"    Non-intersect SNPs: {len(non_intersect):,}")
        print(f"    Intersect SNPs: {len(intersect_data):,}")
        
        # Î∞∞Í≤Ω SNPÎì§ (ÏûëÍ≤å, Ìà¨Î™ÖÌïòÍ≤å)
        if len(non_intersect) > 0:
            # ÎÑàÎ¨¥ ÎßéÏúºÎ©¥ ÏÉòÌîåÎßÅ
            if len(non_intersect) > 50000:
                non_intersect_sample = non_intersect.sample(n=50000, random_state=42)
            else:
                non_intersect_sample = non_intersect
                
            ax.scatter(non_intersect_sample['BP'], non_intersect_sample['-log10P'], 
                      c=colors_background[i], alpha=0.3, s=1, label='Background SNPs')
        
        # Intersect SNPÎì§ (ÌÅ¨Í≤å, ÏßÑÌïòÍ≤å)
        if len(intersect_data) > 0:
            ax.scatter(intersect_data['BP'], intersect_data['-log10P'], 
                      c=colors_intersect[i], alpha=0.8, s=20, 
                      label=f'{celltype} Enhancer SNPs (n={len(intersect_data)})')
        
        # Ïú†ÏùòÏÑ± Í∏∞Ï§ÄÏÑ†
        ax.axhline(y=genome_wide, color='red', linestyle='--', alpha=0.7, 
                  linewidth=1.5, label='p=5√ó10‚Åª‚Å∏')
        ax.axhline(y=suggestive, color='blue', linestyle='--', alpha=0.5, 
                  linewidth=1, label='p=1√ó10‚Åª‚Åµ')
        
        # ÏÉÅÏúÑ intersect SNPÎì§ ÎùºÎ≤®ÎßÅ
        if len(intersect_data) > 0:
            top_intersect = intersect_data.nlargest(3, '-log10P')
            for _, snp in top_intersect.iterrows():
                if snp['-log10P'] > suggestive:
                    ax.annotate(f"{snp['SNP']}", 
                               xy=(snp['BP'], snp['-log10P']),
                               xytext=(5, 5), textcoords='offset points',
                               fontsize=8, alpha=0.8,
                               bbox=dict(boxstyle='round,pad=0.2', 
                                       facecolor=colors_intersect[i], alpha=0.7))
        
        # Ï∂ï ÏÑ§Ï†ï
        ax.set_xlabel('SNP Position (Chr 1)', fontsize=12, fontweight='bold')
        ax.set_ylabel('-log‚ÇÅ‚ÇÄ(P-value)', fontsize=12, fontweight='bold')
        ax.set_title(f'{celltype} Enhancer Manhattan Plot\\n'
                    f'({intersect_count} intersect SNPs)', 
                    fontsize=14, fontweight='bold')
        ax.grid(True, alpha=0.3)
        ax.legend(loc='upper right', fontsize=10)
        
        # YÏ∂ï Î≤îÏúÑ ÏÑ§Ï†ï
        max_y = max(gwas_df['-log10P'].max(), genome_wide + 2)
        ax.set_ylim(0, max_y)
    
    plt.tight_layout()
    
    # Ï†ÄÏû•
    plt.savefig('/scratch/prj/eng_waste_to_protein/repositories/bomin/celltype_manhattan_plots.png', 
                dpi=300, bbox_inches='tight', facecolor='white')
    plt.savefig('/scratch/prj/eng_waste_to_protein/repositories/bomin/celltype_manhattan_plots.pdf', 
                bbox_inches='tight', facecolor='white')
    
    plt.show()
    
    # ÌÜµÍ≥Ñ ÏöîÏïΩ
    print(f"\\nüìà ÏÑ∏Ìè¨ÌÉÄÏûÖÎ≥Ñ Îß®ÌïòÌÉÑ ÌîåÎ°Ø ÌÜµÍ≥Ñ:")
    print("="*60)
    
    for celltype in celltypes:
        intersect_snps = annotations[celltype]['intersect_snps']
        intersect_data = gwas_df[gwas_df['SNP'].isin(intersect_snps)]
        
        if len(intersect_data) > 0:
            significant_intersect = intersect_data[intersect_data['-log10P'] > suggestive]
            genome_wide_intersect = intersect_data[intersect_data['-log10P'] > genome_wide]
            
            print(f"\\nüß¨ {celltype}:")
            print(f"  Total intersect SNPs: {len(intersect_data)}")
            print(f"  Suggestive (p<1e-5): {len(significant_intersect)}")
            print(f"  Genome-wide (p<5e-8): {len(genome_wide_intersect)}")
            
            if len(intersect_data) > 0:
                print(f"  Max -log10(P): {intersect_data['-log10P'].max():.2f}")
                
                # ÏÉÅÏúÑ 3Í∞ú SNP
                top_snps = intersect_data.nlargest(3, '-log10P')
                print(f"  Top SNPs:")
                for _, snp in top_snps.iterrows():
                    print(f"    {snp['SNP']}: p={snp['P']:.2e}")
        else:
            print(f"\\nüß¨ {celltype}: No intersect SNPs found")

def create_comparison_manhattan(gwas_df, annotations):
    """4Í∞ú ÏÑ∏Ìè¨ÌÉÄÏûÖ ÎπÑÍµê Îß®ÌïòÌÉÑ ÌîåÎ°Ø"""
    
    print("\\nüîÑ ÏÑ∏Ìè¨ÌÉÄÏûÖ ÎπÑÍµê Îß®ÌïòÌÉÑ ÌîåÎ°Ø ÏÉùÏÑ± Ï§ë...")
    
    # Îã®Ïùº ÌîåÎ°ØÏóêÏÑú 4Í∞ú ÏÑ∏Ìè¨ÌÉÄÏûÖ ÎπÑÍµê
    fig, ax = plt.subplots(figsize=(16, 10))
    
    celltypes = ['Microglia', 'Neuron', 'Oligodendrocyte', 'Dopaminergic']
    colors = ['red', 'green', 'blue', 'orange']
    
    # Í∞Å ÏÑ∏Ìè¨ÌÉÄÏûÖÎ≥ÑÎ°ú Ï†ê ÌëúÏãú
    for i, celltype in enumerate(celltypes):
        intersect_snps = annotations[celltype]['intersect_snps']
        intersect_data = gwas_df[gwas_df['SNP'].isin(intersect_snps)]
        
        if len(intersect_data) > 0:
            ax.scatter(intersect_data['BP'], intersect_data['-log10P'], 
                      c=colors[i], alpha=0.7, s=15, label=f'{celltype} (n={len(intersect_data)})')
    
    # Ïú†ÏùòÏÑ± Í∏∞Ï§ÄÏÑ†
    genome_wide = -np.log10(5e-8)
    suggestive = -np.log10(1e-5)
    
    ax.axhline(y=genome_wide, color='red', linestyle='--', alpha=0.8, 
              linewidth=2, label='Genome-wide (p=5√ó10‚Åª‚Å∏)')
    ax.axhline(y=suggestive, color='blue', linestyle='--', alpha=0.6, 
              linewidth=1.5, label='Suggestive (p=1√ó10‚Åª‚Åµ)')
    
    # Ï∂ï ÏÑ§Ï†ï
    ax.set_xlabel('SNP Position (Chr 1)', fontsize=14, fontweight='bold')
    ax.set_ylabel('-log‚ÇÅ‚ÇÄ(P-value)', fontsize=14, fontweight='bold')
    ax.set_title('Cell Type-Specific Enhancer Manhattan Plot Comparison', 
                 fontsize=16, fontweight='bold')
    ax.grid(True, alpha=0.3)
    ax.legend(bbox_to_anchor=(1.05, 1), loc='upper left')
    
    plt.tight_layout()
    
    # Ï†ÄÏû•
    plt.savefig('/scratch/prj/eng_waste_to_protein/repositories/bomin/celltype_comparison_manhattan.png', 
                dpi=300, bbox_inches='tight', facecolor='white')
    plt.savefig('/scratch/prj/eng_waste_to_protein/repositories/bomin/celltype_comparison_manhattan.pdf', 
                bbox_inches='tight', facecolor='white')
    
    plt.show()

if __name__ == "__main__":
    print("üóΩ ÏÑ∏Ìè¨ÌÉÄÏûÖÎ≥Ñ enhancer Îß®ÌïòÌÉÑ ÌîåÎ°Ø ÏÉùÏÑ±!")
    print("="*60)
    
    # 1. ÏÑ∏Ìè¨ÌÉÄÏûÖÎ≥Ñ annotation Î°úÎìú
    annotations = load_celltype_annotations()
    
    # 2. GWAS Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    gwas_data = load_gwas_with_positions()
    
    # 3. ÏÑ∏Ìè¨ÌÉÄÏûÖÎ≥Ñ Îß®ÌïòÌÉÑ ÌîåÎ°Ø ÏÉùÏÑ±
    create_celltype_manhattan_plots(gwas_data, annotations)
    
    # 4. ÎπÑÍµê Îß®ÌïòÌÉÑ ÌîåÎ°Ø ÏÉùÏÑ±
    create_comparison_manhattan(gwas_data, annotations)
    
    print(f"\\n‚úÖ ÏÑ∏Ìè¨ÌÉÄÏûÖÎ≥Ñ Îß®ÌïòÌÉÑ ÌîåÎ°Ø ÏÉùÏÑ± ÏôÑÎ£å!")
    print(f"   Ï†ÄÏû•Îêú ÌååÏùº:")
    print(f"   - celltype_manhattan_plots.png (4-panel)")
    print(f"   - celltype_comparison_manhattan.png (overlay)")